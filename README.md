# Floating Point Units on FPGA, Interfaced to PC Over USB
This project was originally conducted as part of the **Spring 2018 Interfacing Circuits Design** course.

Custom floating point units implemented in Verilog and tested on an Xilinx FPGA with an interface to a PC over the series of Asynchronous FIFO, FTDI chip, and USB.
`FPUSB` comprises the Xilinx ISE project for the FPGA chip, whereas `USB_FTDI_Test` includes the Windows software for communicating the FPGA over USB.

## Floating Point Units
There are two custom-designed 27-bit floating point units in this project, a floating point adder and a multiplier.
There is one bit for sign, 8 bits for exponential, and 18 bits for fraction.
The floating units are pipelined for higher performance.
These units are tested by sending numbers to them from a PC over USB.

## FPGA to USB Interfaced
The following image depicts the overall communication interface between FPGA and USB.

<img src="https://github.com/SamanMohseni/FPUSB/assets/51726090/9bbc3310-2615-4d5e-ac41-881e2c4c9fef" width=70% height=70%>

*Image 1. The overall communication interface between FPGA and USB*

To communicate with the computer, a USB interface and an FTDI FT2232H converter chip were used, which provide various protocols such as UART, Asynchronous FIFO, and Synchronous FIFO. We utilized the Asynchronous FIFO mode in this project.

**Functionality of each signal as shown in Image 1:**
- RD#: Pulse for read command (popping data from the FIFO within FT2232H)
- WR#: Pulse for write command (pushing data into the FIFO within FT2232H)
- RXF#: Flag to indicate the presence of data in the FT2232H buffer for reading
- TXE#: Flag to indicate available space in the FT2232H buffer for writing new data

**Asynchronous FIFO mode Timing and signaling:**

<img src="https://github.com/SamanMohseni/FPUSB/assets/51726090/61be22c9-6cee-4b0d-9c54-825e9ef2ba83" width=80% height=80%>
<img src="https://github.com/SamanMohseni/FPUSB/assets/51726090/36ddfa44-3cbc-4fa6-8c59-b1387214af9e" width=75% height=75%>

*Image 2. The timing and signaling from the datasheet*

# FTDI Communication State Machine
The state machine for implementing read and write operations according to the above signaling has been designed (With the FPGA clock set to a frequency of 100MHz):

<img src="https://github.com/SamanMohseni/FPUSB/assets/51726090/763e0e6a-c65f-4684-acff-1b83d9d935c4" width=70% height=70%>

*Image 3. FTDI communication state machine*

The `FTDIController` module is designed based on the above state machine and provides two ports with FIFO standard on the other side:

<img src="https://github.com/SamanMohseni/FPUSB/assets/51726090/1220c8eb-ef24-4243-a24b-186f531a00fb" width=70% height=70%>

*Image 4. FTDI FIFO interface*

Finally, the `FTDIInterface` module is created by connecting two FIFOs (generated by the Core Generator) to the `FTDIController`.

<img src="https://github.com/SamanMohseni/FPUSB/assets/51726090/03204c83-38e5-47f1-ba75-7adc584d28e0" width=70% height=70%>

*Image 5. Overall FTDI interface*

To simultaneously test USB communication and the floating-point multiplier circuit, we design the following circuit:
A pipeline layer is added for the synchronization of data and data_valid arrival (due to a pipeline layer inside the multiplier).

<img src="https://github.com/SamanMohseni/FPUSB/assets/51726090/42bba793-42e4-488a-8dba-f2db816d67a1" width=70% height=70%>

*Image 6. Overall design layout*

## Implementation and Testing:
To communicate with the FT2232H in ASYNC FIFO mode, we need to reconfigure the chip.
The ASYNC FIFO mode configuration is performed through the external EEPROM memory as per the table below.

<img src="https://github.com/SamanMohseni/FPUSB/assets/51726090/d01d6813-0a1e-44b9-bfad-f5d5ab11571a" width=70% height=70%>

*Image 7. Configuration table*

## Setting up the Host PC for Communication:
Installing FT2232H drivers:
In Windows 10, there is no need for driver installation by the user as it is automatically recognized. If driver installation is necessary, refer to [www.ftdichip.com/Support/Documents/InstallGuides.htm](www.ftdichip.com/Support/Documents/InstallGuides.htm).

## Communication Program with the Board:
The program is written in C++ using the `ftd2xx.h` library provided by FTDI.
The program initially takes two floating-point numbers from the user, converts them to the (non-standard!) 27-bit floating-point standard, places each number in a 32-bit format (setting the 5 most significant bits to 0), and then sends 64 bits of data.
Next, it reads 32 bits of data from the FPGA, which is the result of multiplying the two floating-point numbers and displays it.
In general, the sent data are multiples of 32 bits, consisting of 27 bits of the floating-point number and 5 bits of Command, which the Control Unit uses to control the execution process of the algorithm.

The program is located in the project folder at `USB_FTDI_Test`.

## Acknowledgments
Course instructor: [Dr. Majid Nabi](https://scholar.google.com/citations?user=BKPQVhgAAAAJ&hl=en)
